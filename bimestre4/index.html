<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Batimentos</title>
  <style>
    body{font-family:sans-serif;text-align:center;background:#111;color:#eee;margin:0;padding:20px}
    button{margin:8px;padding:10px 16px;font-size:16px;border:0;border-radius:8px;cursor:pointer}
    .start{background:#4caf50;color:#fff}
    .stop{background:#f44336;color:#fff}
    .torch{background:#555;color:#fff}
    #bpm{font-size:48px;font-weight:bold;margin:20px 0}
    video{display:none}
  </style>
</head>
<body>
  <h1>Verificador de Batimentos</h1>
  <p id="status">Aguardando…</p>
  <div id="bpm">--</div>
  <div>
    <button id="startBtn" class="start">Iniciar</button>
    <button id="stopBtn" class="stop" disabled>Parar</button>
    <button id="torchBtn" class="torch" disabled>Lanterna</button>
  </div>
  <video id="video" playsinline autoplay muted></video>
  <script>
    const video=document.getElementById("video"),
          startBtn=document.getElementById("startBtn"),
          stopBtn=document.getElementById("stopBtn"),
          torchBtn=document.getElementById("torchBtn"),
          bpmEl=document.getElementById("bpm"),
          statusEl=document.getElementById("status");

    let stream=null,track=null,torchOn=false,running=false;
    const raw=[],times=[];
    const off=document.createElement("canvas");
    const offCtx=off.getContext("2d",{willReadFrequently:true});

    async function start(){
      if(running) return;
      running=true;bpmEl.textContent="--";statusEl.textContent="Solicitando câmera…";
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",frameRate:{ideal:60}},audio:false});
      }catch(e){statusEl.textContent="Erro ao acessar câmera";running=false;return;}
      video.srcObject=stream;track=stream.getVideoTracks()[0];
      try{await track.applyConstraints({});torchBtn.disabled=false;}catch{torchBtn.disabled=true;}
      startBtn.disabled=true;stopBtn.disabled=false;statusEl.textContent="Cubra a câmera com o dedo";
      raw.length=0;times.length=0;tick();
    }

    function stop(){
      running=false;
      try{stream?.getTracks().forEach(t=>t.stop());}catch{}
      stream=null;track=null;torchOn=false;
      startBtn.disabled=false;stopBtn.disabled=true;torchBtn.disabled=true;
      bpmEl.textContent="--";statusEl.textContent="Parado";
    }

    async function toggleTorch(){
      if(!track) return;
      try{torchOn=!torchOn;await track.applyConstraints({advanced:[{torch:torchOn}]});
        torchBtn.textContent=torchOn?"Lanterna ligada":"Lanterna";
      }catch{statusEl.textContent="Lanterna não suportada";}
    }

    function readIntensity(){
      if(!video.videoWidth) return null;
      const s=Math.floor(Math.min(video.videoWidth,video.videoHeight)*0.25);
      off.width=s;off.height=s;
      const sx=(video.videoWidth-s)/2,sy=(video.videoHeight-s)/2;
      offCtx.drawImage(video,sx,sy,s,s,0,0,s,s);
      const d=offCtx.getImageData(0,0,s,s).data;
      let sum=0,c=0;for(let i=0;i<d.length;i+=4){sum+=d[i];c++;}
      return sum/(c*255);
    }

    function computeBPM(){
      const now=performance.now(),win=10000;
      const idx=times.findIndex(t=>t>now-win);
      const sig=idx>=0?raw.slice(idx):raw.slice();
      const ts=idx>=0?times.slice(idx):times.slice();
      if(sig.length<30) return null;
      const mean=sig.reduce((a,b)=>a+b,0)/sig.length;
      const std=Math.sqrt(sig.reduce((a,b)=>a+(b-mean)**2,0)/sig.length)||1;
      const z=sig.map(v=>(v-mean)/std);
      const peaks=[];
      let last=-1e9;
      for(let i=1;i<z.length-1;i++){
        if(z[i]>0.6&&z[i]>z[i-1]&&z[i]>z[i+1]){
          if(ts[i]-last>300){peaks.push(ts[i]);last=ts[i];}
        }
      }
      if(peaks.length<2) return null;
      const intervals=peaks.slice(1).map((p,i)=>p-peaks[i])
        .filter(x=>x>=300&&x<=1500);
      if(!intervals.length) return null;
      intervals.sort((a,b)=>a-b);
      const med=intervals[Math.floor(intervals.length/2)];
      return Math.round(60000/med);
    }

    function tick(){
      if(!running) return;
      const t=performance.now(),v=readIntensity();
      if(v!=null){
        raw.push(v);times.push(t);
        if(raw.length>1200){raw.shift();times.shift();}
        const bpm=computeBPM();
        bpmEl.textContent=bpm?bpm:"--";
        statusEl.textContent=bpm?"Medindo…":"Ajustando sinal…";
      }
      requestAnimationFrame(tick);
    }

    startBtn.onclick=start;stopBtn.onclick=stop;torchBtn.onclick=toggleTorch;
  </script>
</body>
</html>
