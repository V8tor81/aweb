<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificador de Batimentos (PPG)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#7c8aa5; --primary:#7ae1b8; --accent:#8ea8ff; --danger:#ff7070;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; background:var(--bg); color:#eaf0ff}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .title{font-weight:800;font-size:28px;line-height:1.1;margin:8px 0 2px}
    .subtitle{color:var(--muted);margin:0 0 18px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .05s ease,opacity .2s ease;}
    button:active{transform:translateY(1px)}
    .btn{background:linear-gradient(135deg,var(--primary),#67d2ff);color:#08222a}
    .btn.sec{background:#24314d;color:#eaf0ff}
    .btn.warn{background:var(--danger);color:#2b0f0f}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1a32;color:var(--muted);font-size:12px}
    .bpm{font-size:54px;font-weight:900;letter-spacing:1px}
    .hint{font-size:13px;color:var(--muted)}
    .ok{color:var(--primary)}
    .bad{color:var(--danger)}
    .video-wrap{position:relative;border-radius:14px;overflow:hidden;background:#000}
    video{width:100%;height:auto;display:block;opacity:.35;filter:blur(.2px) saturate(1.2)}
    .overlay{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .ring{width:140px;height:140px;border-radius:50%;border:2px dashed rgba(255,255,255,.3);animation:spin 10s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .footer{font-size:12px;color:var(--muted);margin-top:8px}
    .list{margin:6px 0 0 18px;color:var(--muted)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0a1330;border:1px solid #1c2742;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="pill">Experimento de fotopletismografia (PPG) no navegador</div>
        <h1 class="title">Verificador de Batimentos</h1>
        <p class="subtitle">Use a câmera + lanterna do celular. <strong>Não é dispositivo médico.</strong></p>
      </div>
      <div class="row">
        <button id="startBtn" class="btn">Iniciar medição</button>
        <button id="stopBtn" class="btn sec" disabled>Parar</button>
        <button id="torchBtn" class="btn sec" title="Ativar/Desativar lanterna" disabled>Lanterna</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>
            <div class="pill">BPM estimado</div>
            <div class="bpm" id="bpm">--</div>
            <div class="hint">Qualidade do sinal: <span id="quality">—</span> | Estado: <span id="status">Aguardando…</span></div>
          </div>
          <div>
            <div class="pill" id="torchSupport">Torch: desconhecido</div>
          </div>
        </div>
        <div class="footer">Dica: cubra totalmente a câmera traseira com a ponta do dedo e evite movimentar. Se possível, ative a lanterna.</div>
      </div>

      <div class="card">
        <div class="video-wrap">
          <video id="video" playsinline autoplay muted></video>
          <div class="overlay"><div class="ring"></div></div>
        </div>
        <p class="hint" style="margin-top:10px">
          Alguns celulares só permitem lanterna via navegador no <strong>Chrome Android</strong> (HTTPS). Em iPhone, a lanterna pelo site pode não funcionar; tente uma luz externa.
        </p>
        <details>
          <summary class="hint">Como funciona (PPG)?</summary>
          <ul class="list">
            <li>A câmera capta pequenas variações de luz (sobretudo no canal vermelho) ao atravessar o seu dedo.</li>
            <li>Filtramos o sinal, identificamos picos periódicos e calculamos o intervalo entre batidas.</li>
            <li>Exibimos a média recente (mediana) dos intervalos para estimar o BPM.</li>
          </ul>
        </details>
        <details>
          <summary class="hint">Avisos importantes</summary>
          <ul class="list">
            <li>Experimento educacional. <strong>Não use para diagnósticos.</strong></li>
            <li>Mantenha o dedo apoiado com leve pressão; se doer, pare.</li>
            <li>Evite aquecer demais o dedo com a lanterna; use por períodos curtos.</li>
          </ul>
        </details>
      </div>
    </div>
  </div>

  <script>
    // === Elementos ===
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const torchBtn = document.getElementById('torchBtn');
    const bpmEl = document.getElementById('bpm');
    const statusEl = document.getElementById('status');
    const qualityEl = document.getElementById('quality');
    const torchSupportEl = document.getElementById('torchSupport');

    // === Estado ===
    let stream = null;
    let track = null;
    let imageCapture = null;
    let torchOn = false;
    let running = false;
    let intervalId = null;

    const maxSamples = 1200;
    const raw = [];
    const times = [];

    const off = document.createElement('canvas');
    const offCtx = off.getContext('2d', { willReadFrequently: true });

    function setStatus(t){ statusEl.textContent = t; }

    function movingAverage(arr, win){ /* mesma função do seu código */ }
    function highPass(arr, win){ /* mesma função do seu código */ }
    function lowPassExp(arr, alpha=0.2){ /* mesma função do seu código */ }
    function detectPeaks(sig, ts){ /* mesma função do seu código */ }
    function computeBPM(){ /* mesma função do seu código */ }

    function readIntensity(){
      if(!video.videoWidth) return null;
      const vw = video.videoWidth, vh = video.videoHeight;
      const size = Math.floor(Math.min(vw, vh) * 0.25);
      off.width = size; off.height = size;
      const sx = (vw - size)/2, sy = (vh - size)/2;
      offCtx.drawImage(video, sx, sy, size, size, 0, 0, size, size);
      const data = offCtx.getImageData(0,0,size,size).data;
      let rSum=0, count=0;
      for(let i=0;i<data.length;i+=4){
        rSum += data[i];
        count++;
      }
      return rSum/(count*255);
    }

    async function start(){
      if(running) return;
      running = true;
      bpmEl.textContent = '--';
      qualityEl.textContent = '—';
      setStatus('Solicitando câmera…');
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' }, frameRate: { ideal: 60 }, width: { ideal: 640 }, height: { ideal: 480 } },
          audio: false
        });
      }catch(err){
        setStatus('Permissão negada ou indisponível.');
        console.error(err);
        running = false;
        return;
      }
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];
      try{
        imageCapture = new ImageCapture(track);
        torchBtn.disabled = false;
        torchSupportEl.textContent = 'Torch: disponível (pode depender do navegador)';
      }catch(e){
        imageCapture = null;
        torchBtn.disabled = true;
        torchSupportEl.textContent = 'Torch: indisponível';
      }

      startBtn.disabled = true;
      stopBtn.disabled = false;
      setStatus('Posicione o dedo sobre a câmera e mantenha firme.');

      raw.length = 0; times.length = 0;

      // Atualiza a cada 30 segundos
      intervalId = setInterval(() => {
        const t = performance.now();
        const v = readIntensity();
        if(v != null){
          raw.push(v); times.push(t);
          if(raw.length > maxSamples){ raw.shift(); times.shift(); }
          const { bpm, quality } = computeBPM();
          bpmEl.textContent = bpm ? String(bpm) : '--';
          qualityEl.textContent = quality;
          setStatus(bpm ? 'Medindo… mantenha o dedo firme.' : 'Ajustando sinal…');
          qualityEl.className = quality==='Alta' ? 'hint ok' : (quality==='Baixa' ? 'hint bad' : 'hint');
        }
      }, 30000);
    }

    async function toggleTorch(){
      if(!track) return;
      try{
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        torchBtn.textContent = torchOn ? 'Lanterna (Ligada)' : 'Lanterna';
        setStatus(torchOn ? 'Lanterna ligada.' : 'Lanterna desligada.');
      }catch(e){
        console.warn('Torch falhou:', e);
        setStatus('Não foi possível controlar a lanterna neste dispositivo.');
      }
    }

    function stop(){
      running = false;
      clearInterval(intervalId);
      try{ stream?.getTracks().forEach(t=>t.stop()); }catch{}
      stream = null; track = null; imageCapture = null; torchOn = false;
      startBtn.disabled = false; stopBtn.disabled = true; torchBtn.disabled = true; 
      bpmEl.textContent = '--';
      qualityEl.textContent = '—';
      setStatus('Parado.');
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    torchBtn.addEventListener('click', toggleTorch);

    if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
      setTimeout(()=>{ alert('Para acessar a câmera/lanterna é necessário HTTPS.'); }, 300);
    }
  </script>
</body>
</html>
